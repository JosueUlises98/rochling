<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- Propiedades comunes -->
    <property name="LOG_PATH" value="${LOG_PATH:-./logs}"/>
    <property name="LOG_FILE" value="${LOG_FILE:-logging}"/>
    <property name="ELASTIC_HOSTS" value="${ELASTICSEARCH_HOSTS:-localhost:9200}"/>
    <property name="ELASTIC_INDEX" value="${ELASTIC_INDEX:-logback-logs}"/>

    <!-- Configuración de patrón común -->
    <property name="CONSOLE_LOG_PATTERN"
              value="%d{ISO8601} [%thread] %-5level %logger{36} - %msg%n"/>

    <!-- Appender de Consola -->
    <appender name="Console" class="ch.qos.logback.core.ConsoleAppender">
        <layout class="ch.qos.logback.classic.PatternLayout">
            <Pattern>${CONSOLE_LOG_PATTERN}</Pattern>
        </layout>
    </appender>

    <!-- Appender de Archivo con rotación -->
    <appender name="File" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILE}.log</file>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <Pattern>${CONSOLE_LOG_PATTERN}</Pattern>
        </encoder>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>
                ${LOG_PATH}/archived/${LOG_FILE}-%d{yyyy-MM-dd}.%i.log
            </fileNamePattern>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
            <timeBasedFileNamingAndTriggeringPolicy
                    class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>10MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
        </rollingPolicy>
    </appender>

    <!-- Appender Asíncrono para Elasticsearch -->
    <appender name="AsyncElasticsearch" class="ch.qos.logback.classic.AsyncAppender">
        <!-- Configuración del buffer -->
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>true</includeCallerData>
        <neverBlock>true</neverBlock>

        <!-- Referencia al appender real de Elasticsearch -->
        <appender-ref ref="Elasticsearch"/>
    </appender>

    <!-- Appender de Elasticsearch -->
    <appender name="Elasticsearch" class="com.internetitem.logback.elasticsearch.ElasticsearchAppender">
        <url>${ELASTIC_HOSTS}</url>
        <index>${ELASTIC_INDEX}</index>
        <type>log</type>
        <loggerName>es-logger</loggerName>
        <errorLoggerName>es-error-logger</errorLoggerName>
        <connectTimeout>30000</connectTimeout>
        <readTimeout>30000</readTimeout>
        <maxQueueSize>104857600</maxQueueSize>
        <maxRetries>3</maxRetries>
        <sleepTime>250</sleepTime>
        <bufferSize>8192</bufferSize>
        <includeCallerData>true</includeCallerData>

        <!-- Campos personalizados -->
        <properties>
            <property>
                <name>host</name>
                <value>${HOSTNAME}</value>
                <allowEmpty>false</allowEmpty>
            </property>
            <property>
                <name>severity</name>
                <value>%level</value>
            </property>
            <property>
                <name>thread</name>
                <value>%thread</value>
            </property>
            <property>
                <name>stacktrace</name>
                <value>%ex</value>
            </property>
            <property>
                <name>logger</name>
                <value>%logger</value>
            </property>
        </properties>

        <!-- Plantilla de mensajes -->
        <headers>
            <header>
                <name>Content-Type</name>
                <value>application/json</value>
            </header>
        </headers>
    </appender>

    <!-- Configuración de niveles de log para paquetes específicos -->
    <logger name="org.elasticsearch" level="WARN"/>
    <logger name="com.internetitem.logback.elasticsearch" level="WARN"/>
    <logger name="org.apache.http" level="WARN"/>

    <!-- Configuración para entornos -->
    <springProfile name="dev">
        <root level="DEBUG">
            <appender-ref ref="Console"/>
            <appender-ref ref="File"/>
            <appender-ref ref="AsyncElasticsearch"/>
        </root>
    </springProfile>

    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="Console"/>
            <appender-ref ref="File"/>
            <appender-ref ref="AsyncElasticsearch"/>
        </root>
    </springProfile>

    <!-- Configuración por defecto -->
    <root level="INFO">
        <appender-ref ref="Console"/>
        <appender-ref ref="File"/>
        <appender-ref ref="AsyncElasticsearch"/>
    </root>

</configuration>